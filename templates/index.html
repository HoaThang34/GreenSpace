<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tr√≤ chuy·ªán ‚Äî GreenSpace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="/static/motion.css" />

  <!-- Driver.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css" />
  <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js"></script>

  <style>
    /* Page-specific SVG icons inline */
    .icon-mic {
      width: 16px;
      height: 16px;
    }

    .icon-send {
      width: 16px;
      height: 16px;
    }
  </style>
  <script>
    window.GREETING = "Xin ch√†o, m√¨nh l√† GreenSpace. H√£y coi m√¨nh nh∆∞ m·ªôt khu v∆∞·ªùn y√™n tƒ©nh ƒë·ªÉ nh·ªØng suy nghƒ© c·ªßa b·∫°n ƒë∆∞·ª£c n·∫£y m·∫ßm.\n\nƒê·ªÉ b·∫Øt ƒë·∫ßu, b·∫°n c·∫ßn m·ªôt ng∆∞·ªùi b·∫°n nh∆∞ th·∫ø n√†o ngay l√∫c n√†y ‚Äì m·ªôt ng∆∞·ªùi nh·∫π nh√†ng l·∫Øng nghe, hay m·ªôt ng∆∞·ªùi th·∫≥ng th·∫Øn h∆°n m·ªôt ch√∫t?";
  </script>
</head>

<body class="chat-page-body">
  <!-- Appbar -->
  <header class="appbar fx-reveal">
    <div class="brand">
      <span class="logo">üå±</span>
      <div>
        <span class="brand-title">GreenSpace</span>
        <div class="brand-tagline">Gi√° tr·ªã c·ªët l√µi t·ª´ s·ª± th·∫•u c·∫£m.</div>
      </div>
    </div>

    <nav class="controls-container" id="controlsContainer">
      <div class="controls">
        <button class="chip btn-emergency fx-pulse-emergency" id="emergencyBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
            </path>
          </svg>
          H·ªó tr·ª£ kh·∫©n c·∫•p
        </button>
        <button class="chip" id="newChatBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Tr√≤ chuy·ªán m·ªõi
        </button>
        <button class="chip" id="themeToggle">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          Ch·∫ø ƒë·ªô t·ªëi
        </button>
        <button class="chip" id="statsBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
          L·ªãch s·ª≠ c·∫£m x√∫c
        </button>
        <button class="chip" id="historyBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          L·ªãch s·ª≠
        </button>

        <div class="separator"></div>
        <a href="/community" class="chip" id="tour-community"
          style="background: var(--mood-joy); color: white; border-color: var(--mood-joy);">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          C·ªông ƒë·ªìng
        </a>

        <!-- User menu -->
        <div class="user-menu">
          <button class="chip user-chip" id="userChip">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span id="displayName">{{ display_name }}</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="dropdown-menu" id="dropdownMenu">
            <a href="/profile/{{ username }}" id="myProfileBtn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              H·ªì s∆° c·ªßa t√¥i
            </a>
            <a href="/friends" id="friendsMenuLink">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <line x1="19" y1="8" x2="19" y2="14"></line>
                <line x1="22" y1="11" x2="16" y2="11"></line>
              </svg>
              B·∫°n b√®
            </a>
            <a href="/messages" id="messagesMenuLink">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              Tin nh·∫Øn
              <span id="unreadBadgeMenu" class="badge destructive" style="display:none; margin-left:4px;">0</span>
            </a>
            <div style="height: 1px; background: var(--border); margin: 4px 0;"></div>
            <a href="#" id="changePasswordBtn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              ƒê·ªïi m·∫≠t kh·∫©u
            </a>
            <a href="#" id="logoutBtn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              ƒêƒÉng xu·∫•t
            </a>
          </div>
        </div>
      </div>
    </nav>

    <button class="chip mobile-menu-btn" id="mobileMenuBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
  </header>

  <!-- Chat Content -->
  <main class="chat-container">
    <div class="mood-orb-container">
      <div id="moodOrb" class="mood-orb"></div>
    </div>
    <div id="chat" class="chat-area"></div>
  </main>

  <!-- Composer -->
  <footer class="composer-area fx-reveal">
    <div class="composer">
      <textarea id="inp" placeholder="Chia s·∫ª ƒëi·ªÅu b·∫°n ƒëang nghƒ©‚Ä¶ (Enter ƒë·ªÉ g·ª≠i)" rows="1"></textarea>
      <button id="micBtn" class="mic-btn" title="Nh·∫≠p b·∫±ng gi·ªçng n√≥i">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
          <line x1="12" y1="19" x2="12" y2="23"></line>
          <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
      </button>
      <button id="send" class="send">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </footer>

  <!-- Modals -->
  <div class="modal show" id="intro">
    <div class="panel center fx-reveal" style="max-width: 440px;">
      <div style="font-size: 2.5rem; margin-bottom: 4px;">üå±</div>
      <h1>Ch√†o m·ª´ng ƒë·∫øn v·ªõi <b>GreenSpace</b></h1>
      <p class="muted" style="margin-top: 8px; font-size: 0.9rem; line-height: 1.6;">
        M·ªói h√†nh tr√¨nh ch·ªØa l√†nh ƒë·ªÅu b·∫Øt ƒë·∫ßu t·ª´ nh·ªØng b∆∞·ªõc nh·ªè. <br>
        H√£y gieo m·ªôt h·∫°t m·∫ßm nh·ªè cho t√¢m h·ªìn b·∫°n.
      </p>
      <div class="actions">
        <button class="btn primary fx-pulse" id="start" style="padding: 10px 32px;">B·∫Øt ƒë·∫ßu</button>
      </div>
    </div>
  </div>

  <!-- Emergency Modal -->
  <div class="modal" id="emergencyModal">
    <div class="panel center" style="max-width: 480px;">
      <h1 style="color: var(--destructive);">T√¨m S·ª± Gi√∫p ƒê·ª° Ngay L·∫≠p T·ª©c</h1>
      <p class="muted" style="font-size: 0.9rem; line-height: 1.7; margin-top: 12px;">
        N·∫øu b·∫°n ƒëang c·∫£m th·∫•y kh·ªßng ho·∫£ng ho·∫∑c nghƒ© ƒë·∫øn vi·ªác l√†m h·∫°i b·∫£n th√¢n, xin h√£y bi·∫øt r·∫±ng c√≥ nh·ªØng ng∆∞·ªùi s·∫µn s√†ng
        l·∫Øng nghe v√† gi√∫p ƒë·ª°.
        <br><b>GreenSpace kh√¥ng ph·∫£i l√† d·ªãch v·ª• y t·∫ø hay c·ª©u tr·ª£ kh·∫©n c·∫•p.</b>
        <br>H√£y li√™n h·ªá v·ªõi c√°c chuy√™n gia qua nh·ªØng s·ªë ƒëi·ªán tho·∫°i d∆∞·ªõi ƒë√¢y:
      </p>
      <div class="actions" style="flex-direction: column; gap: 10px; margin-top: 24px;">
        <a href="tel:111" class="btn"
          style="width: 100%; background: var(--mood-joy); color: white; border-color: var(--mood-joy); padding: 12px;">
          <b>G·ªçi 111</b>
          <div style="font-weight: normal; font-size: 0.75rem; opacity: 0.9;">T·ªïng ƒë√†i B·∫£o v·ªá Tr·∫ª em & T∆∞ v·∫•n t√¢m l√Ω
          </div>
        </a>
        <a href="tel:115" class="btn primary" style="width: 100%; padding: 12px;">
          <b>G·ªçi 115</b>
          <div style="font-weight: normal; font-size: 0.75rem; opacity: 0.9;">C·∫•p c·ª©u y t·∫ø kh·∫©n c·∫•p</div>
        </a>
      </div>
      <div class="actions">
        <button id="emergencyCloseBtn" class="btn" style="margin-top: 16px;">ƒê√≥ng c·ª≠a s·ªï n√†y</button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal" id="histModal">
    <div class="panel">
      <div class="histbar">
        <input id="histSearch" placeholder="T√¨m ki·∫øm theo ti√™u ƒë·ªÅ..." />
        <button id="histClose" class="btn">ƒê√≥ng</button>
      </div>
      <div id="histList" class="histlist"></div>
    </div>
  </div>

  <!-- Stats Modal -->
  <div class="modal" id="statsModal">
    <div class="panel">
      <div class="histbar">
        <h2>Th·ªëng k√™ C·∫£m x√∫c Phi√™n</h2>
        <button id="statsClose" class="btn">ƒê√≥ng</button>
      </div>
      <div class="chart-container" style="height: 300px; position: relative;">
        <canvas id="emotionChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal" id="changePasswordModal">
    <div class="panel">
      <div class="histbar">
        <h2>ƒê·ªïi M·∫≠t Kh·∫©u</h2>
        <button id="changePassClose" class="btn">ƒê√≥ng</button>
      </div>
      <form id="changePasswordForm" style="margin-top: 16px;">
        <div style="margin: 12px 0;">
          <label
            style="display: block; margin-bottom: 6px; font-size: 0.8rem; color: var(--muted-foreground); font-weight: 500;">M·∫≠t
            kh·∫©u c≈©</label>
          <input id="oldPass" type="password" required
            style="width: 100%; padding: 10px 12px; border-radius: var(--radius); font-size: 0.9rem; border: 1px solid var(--border); background: var(--background); color: var(--foreground); font-family: inherit;">
        </div>
        <div style="margin: 12px 0;">
          <label
            style="display: block; margin-bottom: 6px; font-size: 0.8rem; color: var(--muted-foreground); font-weight: 500;">M·∫≠t
            kh·∫©u m·ªõi</label>
          <input id="newPass" type="password" required
            style="width: 100%; padding: 10px 12px; border-radius: var(--radius); font-size: 0.9rem; border: 1px solid var(--border); background: var(--background); color: var(--foreground); font-family: inherit;">
        </div>
        <div style="margin: 12px 0;">
          <label
            style="display: block; margin-bottom: 6px; font-size: 0.8rem; color: var(--muted-foreground); font-weight: 500;">X√°c
            nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
          <input id="newPassConfirm" type="password" required
            style="width: 100%; padding: 10px 12px; border-radius: var(--radius); font-size: 0.9rem; border: 1px solid var(--border); background: var(--background); color: var(--foreground); font-family: inherit;">
        </div>
        <button type="submit" class="btn primary" style="width: 100%; margin-top: 8px; height: 40px;">C·∫≠p nh·∫≠t m·∫≠t
          kh·∫©u</button>
      </form>
      <p id="changePassMessage" class="muted"
        style="margin-top: 12px; min-height: 1em; text-align: center; font-size: 0.85rem;"></p>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/static/app.js"></script>
  <script src="/static/theme.js"></script>
  <script src="/static/motion.js"></script>

  <!-- Driver.js Onboarding Tour -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // test again: localStorage.removeItem('greenspace_chat_tour_completed');
      if (!localStorage.getItem('greenspace_chat_tour_completed')) {
        const driver = window.driver.js.driver;
        const driverObj = driver({
          showProgress: true,
          nextBtnText: 'Ti·∫øp theo',
          prevBtnText: 'Quay l·∫°i',
          doneBtnText: 'Ho√†n t·∫•t',
          allowClose: true,
          animate: true,
          smoothScroll: true,
          onDestroyed: () => {
            localStorage.setItem('greenspace_chat_tour_completed', 'true');
          },
          steps: [
            { element: '.brand', popover: { title: 'Kh√¥ng gian c·ªßa b·∫°n üå±', description: 'Trang tr√≤ chuy·ªán ch√≠nh, n∆°i h·∫°t m·∫ßm c·∫£m x√∫c ƒë∆∞·ª£c l·∫Øng nghe v√† nu√¥i d∆∞·ª°ng.', side: "bottom", align: 'start' } },
            { element: '#emergencyBtn', popover: { title: 'H·ªó tr·ª£ kh·∫©n c·∫•p üö®', description: 'N·∫øu b·∫°n c·∫ßn gi√∫p ƒë·ª° y t·∫ø ho·∫∑c t√¢m l√Ω ngay l·∫≠p t·ª©c, h√£y nh·∫•n v√†o ƒë√¢y.', side: "bottom", align: 'start' } },
            { element: '#inp', popover: { title: 'Chia s·∫ª t√¢m t∆∞ üí≠', description: 'Nh·∫≠p suy nghƒ© c·ªßa b·∫°n ·ªü ƒë√¢y. B·∫°n c≈©ng c√≥ th·ªÉ d√πng bi·ªÉu t∆∞·ª£ng micro ƒë·ªÉ x·∫£ l·ªùi t√¢m s·ª±.', side: "top", align: 'start' } },
            { element: '#tour-community', popover: { title: 'K·∫øt n·ªëi m·ªçi ng∆∞·ªùi ü§ù', description: 'Gh√© thƒÉm c·ªông ƒë·ªìng ƒë·ªÉ tr√≤ chuy·ªán v√† s·∫ª chia c√πng nh·ªØng ng∆∞·ªùi b·∫°n m·ªõi nh√©.', side: "bottom", align: 'end' } }
          ]
        });

        // ƒê·ª£i 1 ch√∫t ƒë·ªÉ c√°c animation kh·ªüi t·∫°o xong
        setTimeout(() => {
          driverObj.drive();
        }, 1000);
      }
    });
  </script>
</body>

</html>